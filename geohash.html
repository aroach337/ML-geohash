<!DOCTYPE html>

<html>


<head>
    <title>GeoHash</title>
    <style type="text/css">
        html, body, #map-canvas { height: 100%; margin: 0; padding: 0; }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWj1dLecWvRSiLz99rdI_P7AaDxoz0odw&libraries=drawing,visualization&v=3"></script>
    <script type="text/javascript" src="maplabel.js"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript">
        var theMap;
        
        function drawBoxes(boxes, color) {
            for (var i = 0; i <= boxes.length-1; i++) {
                var box = boxes[i]
                var sw = new google.maps.LatLng(box.south,box.west);
                var ne = new google.maps.LatLng(box.north,box.east);
                var bds = new google.maps.LatLngBounds(sw,ne);
                var rect = new google.maps.Rectangle({
                    strokeColor: color,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: color,
                    fillOpacity: 0.35,
                    map: theMap,
                    bounds: bds
                });
                var mapLabel = new MapLabel({
                    text: box.hash,
                    position: ne,
                    map: theMap,
                    fontSize: 20,
                    align: 'right'
                });
            }
        }

        function drawHashes(hashes) {
          drawBoxes(hashes.interior, '#00FF00');
          drawBoxes(hashes.boundary, '#FF0000');
        }
        
        function fetchHashes(poly) {
            var payload = [];
            poly.getPath().forEach(function(xy, i) {
                payload[i] = {"lat": xy.lat(), "lng": xy.lng() };
            });
            $.ajax({
                 type: "POST",
                 url: "hash.xqy",
                 data: JSON.stringify(payload),
                 contentType: "application/json",
                 dataType: "json",
                 success: drawHashes
            });
        }
                                 
        function initialize() {
            var mapOptions = {
                center: { lat: 37.507377, lng: -122.247081 },
                zoom: 13
            };
            theMap = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);
            
            var drawingManager = new google.maps.drawing.DrawingManager();
            drawingManager.setMap(theMap);
            
            google.maps.event.addListener(drawingManager, 'polygoncomplete', fetchHashes);
        
        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>


<body>
    <div id="map-canvas"></div>
</body>


</html>
